{"content":"<div><div class=\"content\">\n<p>By using <a class=\"xref\" href=\"../../../../../api/system.threading.tasks.task#System_Threading_Tasks_Task_WhenAny_\" data-linktype=\"relative-path\">WhenAny</a>, you can start multiple tasks at the same time and process them one by one as they’re completed rather than process them in the order in which they&#39;re started.  </p>\n<p> The following example uses a query to create a collection of tasks. Each task downloads the contents of a specified website. In each iteration of a while loop, an awaited call to <code>WhenAny</code> returns the task in the collection of tasks that finishes its download first. That task is removed from the collection and processed. The loop repeats until the collection contains no more tasks.  </p>\n<div class=\"NOTE\"><h5>Note</h5><p> To run the examples, you must have Visual Studio 2012 or newer and  the .NET Framework 4.5 or newer installed on your computer.  </p>\n</div>\n<h2 id=\"downloading-the-example\">Downloading the Example</h2>\n<p> You can download the complete Windows Presentation Foundation (WPF) project from <a href=\"http://go.microsoft.com/fwlink/?LinkId=255046\" data-linktype=\"external\">Async Sample: Fine Tuning Your Application</a> and then follow these steps.  </p>\n<ol>\n<li><p>Decompress the file that you downloaded, and then start Visual Studio.  </p>\n</li>\n<li><p>On the menu bar, choose <strong>File</strong>, <strong>Open</strong>, <strong>Project/Solution</strong>.  </p>\n</li>\n<li><p>In the <strong>Open Project</strong> dialog box, open the folder that holds the sample code that you decompressed, and then open the solution (.sln) file for AsyncFineTuningVB.  </p>\n</li>\n<li><p>In <strong>Solution Explorer</strong>, open the shortcut menu for the <strong>ProcessTasksAsTheyFinish</strong> project, and then choose <strong>Set as StartUp Project</strong>.  </p>\n</li>\n<li><p>Choose the F5 key to run the project.  </p>\n<p> Choose the Ctrl+F5 keys to run the project without debugging it.  </p>\n</li>\n<li><p>Run the project several times to verify that the downloaded lengths don&#39;t always appear in the same order.  </p>\n<p>If you don&#39;t want to download the project, you can review the MainWindow.xaml.vb file at the end of this topic.  </p>\n</li>\n</ol>\n<h2 id=\"building-the-example\">Building the Example</h2>\n<p> This example adds to the code that’s developed in <a href=\"cancel-remaining-async-tasks-after-one-is-complete\" data-linktype=\"relative-path\">Cancel Remaining Async Tasks after One Is Complete (Visual Basic)</a> and uses the same UI.  </p>\n<p> To build the example yourself, step by step, follow the instructions in the &quot;Downloading the Example&quot; section, but choose <strong>CancelAfterOneTask</strong> as the <strong>StartUp Project</strong>. Add the changes in this topic to the <code>AccessTheWebAsync</code> method in that project. The changes are marked with asterisks.  </p>\n<p> The <strong>CancelAfterOneTask</strong> project already includes a query that, when executed, creates a collection of tasks. Each call to <code>ProcessURLAsync</code> in the following code returns a <a class=\"xref\" href=\"../../../../../api/system.threading.tasks.task-1\" data-linktype=\"relative-path\">Task&lt;TResult&gt;</a> where <code>TResult</code> is an integer.  </p>\n<p><codecontentplaceholder>0</codecontentplaceholder><br> In the MainWindow.xaml.vb file of the  project, make the following changes to the <code>AccessTheWebAsync</code> method.  </p>\n<ul>\n<li>Execute the query by applying <a class=\"xref\" href=\"https://msdn.microsoft.com/en-us/library/bb342261(v=vs.110).aspx\" data-linktype=\"external\">Enumerable.ToList</a> instead of <a class=\"xref\" href=\"https://msdn.microsoft.com/en-us/library/bb298736(v=vs.110).aspx\" data-linktype=\"external\">ToArray</a>.  </li>\n</ul>\n<p><codecontentplaceholder>1</codecontentplaceholder>  </p>\n<ul>\n<li><p>Add a while loop that performs the following steps for each task in the collection.  </p>\n<ol>\n<li>Awaits a call to <code>WhenAny</code> to identify the first task in the collection to finish its download.  </li>\n</ol>\n</li>\n</ul>\n<p><codecontentplaceholder>2</codecontentplaceholder>  </p>\n<ol>\n<li>Removes that task from the collection.  </li>\n</ol>\n<p><codecontentplaceholder>3</codecontentplaceholder>  </p>\n<ol>\n<li><p>Awaits <code>firstFinishedTask</code>, which is returned by a call to <code>ProcessURLAsync</code>. The <code>firstFinishedTask</code> variable is a <a class=\"xref\" href=\"../../../../../api/system.threading.tasks.task-1\" data-linktype=\"relative-path\">Task&lt;TResult&gt;</a> where <code>TReturn</code> is an integer. The task is already complete, but you await it to retrieve the length of the downloaded website, as the following example shows.  </p>\n<pre class=\"loading\"><code class=\"lang-vb\">Dim length = Await firstFinishedTask  \nresultsTextBox.Text &amp;= String.Format(vbCrLf &amp; &quot;Length of the downloaded website:  {0}&quot; &amp; vbCrLf, length)  \n</code></pre><p>You should run the project several times to verify that the downloaded lengths don&#39;t always appear in the same order.  </p>\n</li>\n</ol>\n<div class=\"CAUTION\"><h5>Caution</h5><p> You can use <code>WhenAny</code> in a loop, as described in the example, to solve problems that involve a small number of tasks. However, other approaches are more efficient if you have a large number of tasks to process. For more information and examples, see <a href=\"http://go.microsoft.com/fwlink/?LinkId=260810\" data-linktype=\"external\">Processing Tasks as they complete</a>.  </p>\n</div>\n<h2 id=\"complete-example\">Complete Example</h2>\n<p> The following code is the complete text of the MainWindow.xaml.vb file for the example. Asterisks mark the elements that were added for this example.  </p>\n<p> Notice that you must add a reference for <a class=\"xref\" href=\"../../../../../api/system.net.http\" data-linktype=\"relative-path\">System.Net.Http</a>.  </p>\n<p> You can download the project from <a href=\"http://go.microsoft.com/fwlink/?LinkId=255046\" data-linktype=\"external\">Async Sample: Fine Tuning Your Application</a>.  </p>\n<pre class=\"loading\"><code class=\"lang-vb\">&#39; Add an Imports directive and a reference for System.Net.Http.  \nImports System.Net.Http  \n\n&#39; Add the following Imports directive for System.Threading.  \nImports System.Threading  \n\nClass MainWindow  \n\n    &#39; Declare a System.Threading.CancellationTokenSource.  \n    Dim cts As CancellationTokenSource  \n\n    Private Async Sub startButton_Click(sender As Object, e As RoutedEventArgs)  \n\n        &#39; Instantiate the CancellationTokenSource.  \n        cts = New CancellationTokenSource()  \n\n        resultsTextBox.Clear()  \n\n        Try  \n            Await AccessTheWebAsync(cts.Token)  \n            resultsTextBox.Text &amp;= vbCrLf &amp; &quot;Downloads complete.&quot;  \n\n        Catch ex As OperationCanceledException  \n            resultsTextBox.Text &amp;= vbCrLf &amp; &quot;Downloads canceled.&quot; &amp; vbCrLf  \n\n        Catch ex As Exception  \n            resultsTextBox.Text &amp;= vbCrLf &amp; &quot;Downloads failed.&quot; &amp; vbCrLf  \n        End Try  \n\n        &#39; Set the CancellationTokenSource to Nothing when the download is complete.  \n        cts = Nothing  \n    End Sub  \n\n    &#39; You can still include a Cancel button if you want to.  \n    Private Sub cancelButton_Click(sender As Object, e As RoutedEventArgs)  \n\n        If cts IsNot Nothing Then  \n            cts.Cancel()  \n        End If  \n    End Sub  \n\n    &#39; Provide a parameter for the CancellationToken.  \n    &#39; Change the return type to Task because the method has no return statement.  \n    Async Function AccessTheWebAsync(ct As CancellationToken) As Task  \n\n        Dim client As HttpClient = New HttpClient()  \n\n        &#39; Call SetUpURLList to make a list of web addresses.  \n        Dim urlList As List(Of String) = SetUpURLList()  \n\n        &#39; ***Create a query that, when executed, returns a collection of tasks.  \n        Dim downloadTasksQuery As IEnumerable(Of Task(Of Integer)) =  \n            From url In urlList Select ProcessURLAsync(url, client, ct)  \n\n        &#39; ***Use ToList to execute the query and start the download tasks.   \n        Dim downloadTasks As List(Of Task(Of Integer)) = downloadTasksQuery.ToList()  \n\n        &#39; ***Add a loop to process the tasks one at a time until none remain.  \n        While downloadTasks.Count &gt; 0  \n            &#39; ***Identify the first task that completes.  \n            Dim firstFinishedTask As Task(Of Integer) = Await Task.WhenAny(downloadTasks)  \n\n            &#39; ***Remove the selected task from the list so that you don&#39;t  \n            &#39; process it more than once.  \n            downloadTasks.Remove(firstFinishedTask)  \n\n            &#39; ***Await the first completed task and display the results.  \n            Dim length = Await firstFinishedTask  \n            resultsTextBox.Text &amp;= String.Format(vbCrLf &amp; &quot;Length of the downloaded website:  {0}&quot; &amp; vbCrLf, length)  \n        End While  \n\n    End Function  \n\n    &#39; Bundle the processing steps for a website into one async method.  \n    Async Function ProcessURLAsync(url As String, client As HttpClient, ct As CancellationToken) As Task(Of Integer)  \n\n        &#39; GetAsync returns a Task(Of HttpResponseMessage).   \n        Dim response As HttpResponseMessage = Await client.GetAsync(url, ct)  \n\n        &#39; Retrieve the website contents from the HttpResponseMessage.  \n        Dim urlContents As Byte() = Await response.Content.ReadAsByteArrayAsync()  \n\n        Return urlContents.Length  \n    End Function  \n\n    &#39; Add a method that creates a list of web addresses.  \n    Private Function SetUpURLList() As List(Of String)  \n\n        Dim urls = New List(Of String) From  \n            {  \n                &quot;http://msdn.microsoft.com&quot;,  \n                &quot;http://msdn.microsoft.com/library/hh290138.aspx&quot;,  \n                &quot;http://msdn.microsoft.com/library/hh290140.aspx&quot;,  \n                &quot;http://msdn.microsoft.com/library/dd470362.aspx&quot;,  \n                &quot;http://msdn.microsoft.com/library/aa578028.aspx&quot;,  \n                &quot;http://msdn.microsoft.com/library/ms404677.aspx&quot;,  \n                &quot;http://msdn.microsoft.com/library/ff730837.aspx&quot;  \n            }  \n        Return urls  \n    End Function  \n\nEnd Class  \n\n&#39; Sample output:  \n\n&#39; Length of the download:  226093  \n&#39; Length of the download:  412588  \n&#39; Length of the download:  175490  \n&#39; Length of the download:  204890  \n&#39; Length of the download:  158855  \n&#39; Length of the download:  145790  \n&#39; Length of the download:  44908  \n&#39; Downloads complete.  \n</code></pre><h2 id=\"see-also\">See Also</h2>\n<p> <a class=\"xref\" href=\"../../../../../api/system.threading.tasks.task#System_Threading_Tasks_Task_WhenAny_\" data-linktype=\"relative-path\">WhenAny</a><br> <a href=\"fine-tuning-your-async-application\" data-linktype=\"relative-path\">Fine-Tuning Your Async Application (Visual Basic)</a><br> <a href=\"index\" data-linktype=\"relative-path\">Asynchronous Programming with Async and Await (Visual Basic)</a><br> <a href=\"http://go.microsoft.com/fwlink/?LinkId=255046\" data-linktype=\"external\">Async Sample: Fine Tuning Your Application</a></p>\n</div></div>","outputRootRelativePath":"../../../../../","pageMetadata":"<meta name=\"author\" content=\"stevehoag\">\r\n<meta name=\"ms.author\" content=\"shoag\">\r\n<meta name=\"manager\" content=\"wpickett\">\r\n<meta name=\"breadcrumb_path\" content=\"/dotnet-internal/toc2.json\">\r\n<meta name=\"ms.suite\" content=\"\">\r\n<meta name=\"ms.custom\" content=\"\">\r\n<meta name=\"ms.tgt_pltfrm\" content=\"\">\r\n<meta name=\"ms.assetid\" content=\"57ffb748-af40-4794-bedd-bdb7fea062de\">\r\n<meta name=\"caps.latest.revision\" content=\"3\">\r\n<meta name=\"ms.topic\" content=\"article\">\r\n<meta name=\"translation.priority.mt\" content=\"cs-cz\">\r\n<meta name=\"translation.priority.mt\" content=\"pl-pl\">\r\n<meta name=\"translation.priority.mt\" content=\"pt-br\">\r\n<meta name=\"translation.priority.mt\" content=\"tr-tr\">\r\n<meta name=\"ms.date\" content=\"2015-07-20\">\r\n<meta name=\"ms.technology\" content=\"devlang-visual-basic\">\r\n<meta name=\"ms.prod\" content=\".net\">\r\n<meta name=\"ms.reviewer\" content=\"\">\r\n<meta name=\"search.ms_sitename\" content=\"Docs\">\r\n<meta name=\"search.ms_docsetname\" content=\"docs-internal\">\r\n<meta name=\"version\" content=\"0\">\r\n<meta name=\"locale\" content=\"en-us\">\r\n<meta name=\"site_name\" content=\"Docs\">\r\n<meta name=\"search.ms_product\" content=\"MSDN\">\r\n<meta name=\"depot_name\" content=\"MSDN.docs-internal\">\r\n<meta name=\"updated_at\" content=\"2017-03-15 06:14 PM\">\r\n<meta name=\"gitcommit\" content=\"https://github.com/dotnet/docs-internal/blob/0a5d76c154aeb9b749c9c3fc5ad0962e93754a62/docs/visual-basic/programming-guide/concepts/async/start-multiple-async-tasks-and-process-them-as-they-complete.md\">\r\n<meta name=\"original_content_git_url\" content=\"https://github.com/dotnet/docs-internal/blob/master/docs/visual-basic/programming-guide/concepts/async/start-multiple-async-tasks-and-process-them-as-they-complete.md\">\r\n<meta name=\"document_id\" content=\"8533203d-e03c-2b59-93fc-d75efb18d06b\">\r\n<meta name=\"pagetype\" content=\"Conceptual\">\r\n<meta name=\"toc_rel\" content=\"toc2.json\">\r\n","rawMetadata":{"author":"stevehoag","ms.author":"shoag","manager":"wpickett","breadcrumb_path":"/dotnet-internal/toc.json","title":"Start Multiple Async Tasks and Process Them As They Complete (Visual Basic) | Microsoft Docs","ms.suite":"","ms.custom":"","ms.tgt_pltfrm":"","ms.assetid":"57ffb748-af40-4794-bedd-bdb7fea062de","caps.latest.revision":3,"ms.topic":"article","dev_langs":["vb"],"translation.priority.mt":["cs-cz","pl-pl","pt-br","tr-tr"],"ms.date":"2015-07-20","ms.technology":["devlang-visual-basic"],"ms.prod":".net","ms.reviewer":"","search.ms_sitename":"Docs","search.ms_docsetname":"docs-internal","version":0,"_op_canonicalUrlPrefix":"https://docs.microsoft.com/en-us/dotnet-internal/","locale":"en-us","site_name":"Docs","search.ms_product":"MSDN","_op_openToPublicContributors":false,"depot_name":"MSDN.docs-internal","_op_gitCommitHistory":[{"author_name":"Steve Hoag","author_email":"shoag@microsoft.com","committer_name":"GitHub","comitter_email":"noreply@github.com","message":"Reorganizing the VB TOC (#1348)","commit_sha":"0a5d76c154aeb9b749c9c3fc5ad0962e93754a62","commit_date":"2017-02-14 10:22:48 -0800"},{"author_name":"Maira Wenzel","author_email":"mairaw@microsoft.com","committer_name":"GitHub","comitter_email":"noreply@github.com","message":"Metadata updates (#1313)","commit_sha":"90fe68f7f3c4b46502b5d3770b1a2d57c6af748a","commit_date":"2016-12-09 12:40:41 -0800"},{"author_name":"Maira Wenzel","author_email":"mairaw@microsoft.com","committer_name":"Bill Wagner","comitter_email":"wiwagn@microsoft.com","message":":books: migration changes (#1235)","commit_sha":"b828bb1d6c8fb750ad9ef34f8a7a1b7d2574f4c6","commit_date":"2016-11-15 15:08:11 -0500"}],"updated_at":"2017-03-15 06:14 PM","_op_gitContributorInformation":{"author":{"profile_url":"https://github.com/stevehoag","display_name":"Steve Hoag","id":"13489215"},"contributors":[{"profile_url":"https://github.com/stevehoag","display_name":"Steve Hoag"},{"profile_url":"https://github.com/mairaw","display_name":"Maira Wenzel","id":"12971179"}],"update_at":"3/15/2017"},"gitcommit":"https://github.com/dotnet/docs-internal/blob/0a5d76c154aeb9b749c9c3fc5ad0962e93754a62/docs/visual-basic/programming-guide/concepts/async/start-multiple-async-tasks-and-process-them-as-they-complete.md","original_content_git_url":"https://github.com/dotnet/docs-internal/blob/master/docs/visual-basic/programming-guide/concepts/async/start-multiple-async-tasks-and-process-them-as-they-complete.md","open_to_public_contributors":false,"content_git_url":"https://github.com/dotnet/docs/blob/master/docs/visual-basic/programming-guide/concepts/async/start-multiple-async-tasks-and-process-them-as-they-complete.md","document_id":"8533203d-e03c-2b59-93fc-d75efb18d06b","layout":"Conceptual","pagetype":"Conceptual","canonical_url":"https://docs.microsoft.com/en-us/dotnet-all/articles/visual-basic/programming-guide/concepts/async/start-multiple-async-tasks-and-process-them-as-they-complete","toc_asset_id":"articles/visual-basic/programming-guide/concepts/async/toc.json","toc_rel":"toc.json","_op_ogTitle":"Start Multiple Async Tasks and Process Them As They Complete (Visual Basic)","_op_displayDate":null,"_op_displayDate_source":null,"_op_wordCount":1088,"_op_rawTitle":"<h1 id=\"start-multiple-async-tasks-and-process-them-as-they-complete-visual-basic\" sourcefile=\"docs/visual-basic/programming-guide/concepts/async/start-multiple-async-tasks-and-process-them-as-they-complete.md\" sourcestartlinenumber=\"25\" sourceendlinenumber=\"25\">Start Multiple Async Tasks and Process Them As They Complete (Visual Basic)</h1>","_op_searchScope":[".NET"],"_op_canonicalUrl":"https://docs.microsoft.com/en-us/dotnet-all/articles/visual-basic/programming-guide/concepts/async/start-multiple-async-tasks-and-process-them-as-they-complete","fileRelativePath":"articles/visual-basic/programming-guide/concepts/async/start-multiple-async-tasks-and-process-them-as-they-complete.html"},"themesRelativePathToOutputRoot":"_themes/"}