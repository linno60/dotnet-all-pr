{"content":"<div><div class=\"content\">\n<p>This example shows how to use a concurrent bag to implement an object pool. Object pools can improve application performance in situations where you require multiple instances of a class and the class is expensive to create or destroy. When a client program requests a new object, the object pool first attempts to provide one that has already been created and returned to the pool. If none is available, only then is a new object created. </p>\n<p><a href=\"https://docs.microsoft.com/dotnet/core/api/System.Collections.Concurrent.ConcurrentBag-1\" data-linktype=\"external\">ConcurrentBag&lt;T&gt;</a> is used to store the objects because it supports fast insertion and removal, especially when the same thread is both adding and removing items. This example could be further augmented to be built around a <a href=\"https://docs.microsoft.com/dotnet/core/api/System.Collections.Concurrent.IProducerConsumerCollection-1\" data-linktype=\"external\">IProducerConsumerCollection&lt;T&gt;</a>, which the bag data structure implements, as do <a href=\"https://docs.microsoft.com/dotnet/core/api/System.Collections.Concurrent.ConcurrentQueue-1\" data-linktype=\"external\">ConcurrentQueue&lt;T&gt;</a> and <a href=\"https://docs.microsoft.com/dotnet/core/api/System.Collections.Concurrent.ConcurrentStack-1\" data-linktype=\"external\">ConcurrentStack&lt;T&gt;</a>.</p>\n<h2 id=\"example\">Example</h2>\n<pre class=\"loading\"><code class=\"lang-csharp\">using System;\nusing System.Collections.Concurrent;\nusing System.Threading;\nusing System.Threading.Tasks;\n\n\nnamespace ObjectPoolExample\n{\n    public class ObjectPool&lt;T&gt;\n    {\n        private ConcurrentBag&lt;T&gt; _objects;\n        private Func&lt;T&gt; _objectGenerator;\n\n        public ObjectPool(Func&lt;T&gt; objectGenerator)\n        {\n            if (objectGenerator == null) throw new ArgumentNullException(&quot;objectGenerator&quot;);\n\n            _objects = new ConcurrentBag&lt;T&gt;();\n            _objectGenerator = objectGenerator;\n        }\n\n        public T GetObject()\n        {\n            T item;\n            return _objects.TryTake(out item) ? item : _objectGenerator();\n        }\n\n        public void PutObject(T item)\n        {\n            _objects.Add(item);\n        }\n    }\n\n    class Program\n    {\n       static void Main(string[] args)\n        {\n            CancellationTokenSource cts = new CancellationTokenSource();\n\n            // Create an opportunity for the user to cancel.\n            Task.Run(() =&gt;\n                {\n                    if (Console.ReadKey().KeyChar == &#39;c&#39; || Console.ReadKey().KeyChar == &#39;C&#39;)\n                        cts.Cancel();\n                });\n\n            ObjectPool&lt;MyClass&gt; pool = new ObjectPool&lt;MyClass&gt; (() =&gt; new MyClass());            \n\n            // Create a high demand for MyClass objects.\n            Parallel.For(0, 1000000, (i, loopState) =&gt;\n                {\n                    MyClass mc = pool.GetObject();\n                    Console.CursorLeft = 0;\n                    // This is the bottleneck in our application. All threads in this loop\n                    // must serialize their access to the static Console class.\n                    Console.WriteLine(&quot;{0:####.####}&quot;, mc.GetValue(i));                 \n\n                    pool.PutObject(mc);\n                    if (cts.Token.IsCancellationRequested)\n                        loopState.Stop();                 \n                });\n            Console.WriteLine(&quot;Press the Enter key to exit.&quot;);\n            Console.ReadLine();\n            cts.Dispose();\n        }\n    }\n\n    // A toy class that requires some resources to create.\n    // You can experiment here to measure the performance of the\n    // object pool vs. ordinary instantiation.\n    class MyClass\n    {\n        public int[] Nums {get; set;}\n        public double GetValue(long i)\n        {\n            return Math.Sqrt(Nums[i]);\n        }\n        public MyClass()\n        {\n            Nums = new int[1000000];\n            Random rand = new Random();\n            for (int i = 0; i &lt; Nums.Length; i++)\n                Nums[i] = rand.Next();\n        }\n    }   \n}\n</code></pre><h2 id=\"see-also\">See Also</h2>\n<p><a href=\"https://docs.microsoft.com/dotnet/core/api/System.Collections.Concurrent\" data-linktype=\"external\">System.Collections.Concurrent</a></p>\n<p><a href=\"index\" data-linktype=\"relative-path\">Thread-Safe Collections</a></p>\n</div></div>","outputRootRelativePath":"../../../../","pageMetadata":"<meta name=\"author\" content=\"mairaw\">\r\n<meta name=\"ms.author\" content=\"mairaw\">\r\n<meta name=\"manager\" content=\"wpickett\">\r\n<meta name=\"breadcrumb_path\" content=\"../toc2.json\">\r\n<meta name=\"ms.devlang\" content=\"dotnet\">\r\n<meta name=\"ms.assetid\" content=\"87a6ada1-ee27-423d-b587-82e7cb45361b\">\r\n<meta name=\"description\" content=\"How to: Create an Object Pool by Using a ConcurrentBag\">\r\n<meta name=\"keywords\" content=\".NET, .NET Core\">\r\n<meta name=\"ms.topic\" content=\"article\">\r\n<meta name=\"ms.date\" content=\"06/20/2016\">\r\n<meta name=\"ms.technology\" content=\"dotnet-standard\">\r\n<meta name=\"ms.prod\" content=\".net\">\r\n<meta name=\"search.ms_sitename\" content=\"Docs\">\r\n<meta name=\"search.ms_docsetname\" content=\"docs-internal\">\r\n<meta name=\"version\" content=\"0\">\r\n<meta name=\"locale\" content=\"en-us\">\r\n<meta name=\"site_name\" content=\"Docs\">\r\n<meta name=\"search.ms_product\" content=\"MSDN\">\r\n<meta name=\"depot_name\" content=\"MSDN.docs-internal\">\r\n<meta name=\"updated_at\" content=\"2016-12-15 06:00 PM\">\r\n<meta name=\"gitcommit\" content=\"https://github.com/dotnet/docs-internal/blob/90fe68f7f3c4b46502b5d3770b1a2d57c6af748a/docs/standard/collections/threadsafe/how-to-create-an-object-pool.md\">\r\n<meta name=\"original_content_git_url\" content=\"https://github.com/dotnet/docs-internal/blob/master/docs/standard/collections/threadsafe/how-to-create-an-object-pool.md\">\r\n<meta name=\"document_id\" content=\"87d9aed6-74d3-b5d5-a052-adc7211425f3\">\r\n<meta name=\"pagetype\" content=\"Conceptual\">\r\n<meta name=\"toc_rel\" content=\"../../../toc2.json\">\r\n","rawMetadata":{"author":"mairaw","ms.author":"mairaw","manager":"wpickett","breadcrumb_path":"/dotnet/toc.json","title":"How to: Create an Object Pool by Using a ConcurrentBag | Microsoft Docs","ms.devlang":"dotnet","ms.assetid":"87a6ada1-ee27-423d-b587-82e7cb45361b","description":"How to: Create an Object Pool by Using a ConcurrentBag","keywords":".NET, .NET Core","ms.topic":"article","ms.date":"06/20/2016","ms.technology":"dotnet-standard","ms.prod":".net","search.ms_sitename":"Docs","search.ms_docsetname":"docs-internal","version":0,"_op_canonicalUrlPrefix":"https://docs.microsoft.com/en-us/dotnet-internal/","locale":"en-us","site_name":"Docs","search.ms_product":"MSDN","_op_openToPublicContributors":false,"depot_name":"MSDN.docs-internal","_op_gitCommitHistory":[{"author_name":"Maira Wenzel","author_email":"mairaw@microsoft.com","committer_name":"GitHub","comitter_email":"noreply@github.com","message":"Metadata updates (#1313)","commit_sha":"90fe68f7f3c4b46502b5d3770b1a2d57c6af748a","commit_date":"2016-12-09 12:40:41 -0800"},{"author_name":"Kijana Woodard","author_email":"github@wyldeye.com","committer_name":"Maira Wenzel","comitter_email":"mairaw@microsoft.com","message":"remove up excess braces (#911)","commit_sha":"2f8dede4c6f679466e8441b29cf778dc46059196","commit_date":"2016-08-16 15:10:15 -0700"},{"author_name":"Kijana Woodard","author_email":"github@wyldeye.com","committer_name":"Bill Wagner","comitter_email":"wiwagn@microsoft.com","message":"remove excess braces (#909)","commit_sha":"424fd3c096712b1665e4d351de8e8f91553141eb","commit_date":"2016-08-16 09:24:58 -0400"},{"author_name":"Duncan Mackenzie","author_email":"duncanma@microsoft.com","committer_name":"Maira Wenzel","comitter_email":"mairaw@microsoft.com","message":"Removing colons from the metadata as a test (#748)","commit_sha":"c15f2da15c6448cf1c36dea2d5fd53e734bb6608","commit_date":"2016-07-07 23:26:06 -0700"},{"author_name":"Maira Wenzel","author_email":"mairaw@users.noreply.github.com","committer_name":"Rich Lander","comitter_email":"rlander@microsoft.com","message":"fixed generic links (#658)","commit_sha":"e07788926a995b41571be276379ad9285747951d","commit_date":"2016-06-26 16:20:19 -0700"},{"author_name":"Tom Dykstra","author_email":"tdykstra@microsoft.com","committer_name":"Rich Lander","comitter_email":"rlander@microsoft.com","message":"make index.md for collections and threadsafe folders (#635)","commit_sha":"2229d5a150d7d262b2ea42d0b15d7be0e152de47","commit_date":"2016-06-25 13:37:11 -0700"},{"author_name":"Tom Dykstra","author_email":"tdykstra@microsoft.com","committer_name":"GitHub","comitter_email":"noreply@github.com","message":"move files for standard section of toc (#615)","commit_sha":"9cf6022fc910bc5418c03c0fa81d9432d85be3b0","commit_date":"2016-06-24 14:14:05 -0700"}],"updated_at":"2016-12-15 06:00 PM","_op_gitContributorInformation":{"author":{"profile_url":"https://github.com/mairaw","display_name":"Maira Wenzel","id":"12971179"},"contributors":[{"profile_url":"https://github.com/mairaw","display_name":"Maira Wenzel"},{"profile_url":"https://github.com/kijanawoodard","display_name":"Kijana Woodard","id":"152013"},{"profile_url":"https://github.com/DuncanmaMSFT","display_name":"Duncan Mackenzie","id":"18338424"},{"profile_url":"https://github.com/tdykstra","display_name":"Tom Dykstra","id":"1569635"}],"update_at":"12/15/2016"},"gitcommit":"https://github.com/dotnet/docs-internal/blob/90fe68f7f3c4b46502b5d3770b1a2d57c6af748a/docs/standard/collections/threadsafe/how-to-create-an-object-pool.md","original_content_git_url":"https://github.com/dotnet/docs-internal/blob/master/docs/standard/collections/threadsafe/how-to-create-an-object-pool.md","open_to_public_contributors":false,"content_git_url":"https://github.com/dotnet/docs/blob/master/docs/standard/collections/threadsafe/how-to-create-an-object-pool.md","document_id":"87d9aed6-74d3-b5d5-a052-adc7211425f3","layout":"Conceptual","pagetype":"Conceptual","canonical_url":"https://docs.microsoft.com/en-us/dotnet/articles/standard/collections/threadsafe/how-to-create-an-object-pool","toc_asset_id":"articles/toc.json","toc_rel":"../../../toc.json","_op_ogTitle":"How to: Create an Object Pool by Using a ConcurrentBag","_op_displayDate":"2016-6-20","_op_displayDate_source":"2016-06-20T00:00:00Z","_op_wordCount":364,"_op_rawTitle":"<h1 id=\"how-to-create-an-object-pool-by-using-a-concurrentbag\" sourcefile=\"docs/standard/collections/threadsafe/how-to-create-an-object-pool.md\" sourcestartlinenumber=\"15\" sourceendlinenumber=\"15\">How to: Create an Object Pool by Using a ConcurrentBag</h1>","_op_searchScope":[".NET"],"_op_canonicalUrl":"https://docs.microsoft.com/en-us/dotnet/articles/standard/collections/threadsafe/how-to-create-an-object-pool","fileRelativePath":"articles/standard/collections/threadsafe/how-to-create-an-object-pool.html"},"themesRelativePathToOutputRoot":"_themes/"}